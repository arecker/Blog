<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Using Selenium to Buy a Bus Pass | A brief tutorial of my new favorite Selenium script.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@alex_recker" />
    <meta name="twitter:title" content="Using Selenium to Buy a Bus Pass" />
    <meta name="twitter:description" content="A brief tutorial of my new favorite Selenium script." />
    <meta property="og:url" content="/using-selenium-buy-bus-pass/" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Using Selenium to Buy a Bus Pass"/>
    <meta property="og:description" content="A brief tutorial of my new favorite Selenium script." />
    
    <link href="/assets/site.css" rel="stylesheet"/>
  </head>
  <body>
    <header>
      <h1 class="title">Using Selenium to Buy a Bus Pass</h1>
      <h2 class="subtitle">A brief tutorial of my new favorite Selenium script.</h2>
    </header>
    <hr/>
    <nav>
      
      
      <a href="/">index.html</a>
      <span> / </span>
      <span>selenium-bus-pass.html</span>
      
      <span class="float-right hide-on-mobile">
	
	<a href="/entries.html">entries.html</a>
	
	<a href="/archives.html">archives.html</a>
	
	<a href="/stats.html">stats.html</a>
	
	<a href="/contact.html">contact.html</a>
	
      </span>
      <span class="show-on-mobile">
	
	<a href="/entries.html">entries.html</a>
	
	<a href="/archives.html">archives.html</a>
	
	<a href="/stats.html">stats.html</a>
	
	<a href="/contact.html">contact.html</a>
	
      </span>
    </nav>
    <hr/>
    
    <p>I take the bus everyday. It’s terrific. There’s nothing better than
getting a full sixty minutes everyday to close your eyes, drink
coffee, and get lost in a podcast before work.</p>

<p>I wish I could say that purchasing bus passes from Madison’s website
was just as relaxing. Because my wife picks me up from work in the
afternoon, it is most cost effective for me to buy a new Adult 10 Ride
voucher every two weeks. Every two weeks, I have to dig through their
crusty website to find their purchase form. All in all, there are
about six pages across two different domains - each loaded with their
own set of over-crowded menus and repetitive forms.</p>

<p>I am sure I was using the site wrong. At one point I tried to make a
persistent account. I bailed half way through, fearing I was
<em>actually</em> about to sign up for a miracle pill or a magazine
subscription.</p>

<h2 id="the-year-of-automation">The Year of Automation</h2>

<p>There had to be another way! Sure, perhaps the old 2015 Alex would
have just endured this bi-weekly punishment. But this is 2016,
damnit. Even typing those numbers in this blog post makes me feel like
I am living in a science fiction novel.</p>

<p>This year, I decided not to put up with this chore. I decided to
adapt, survive, and make a Selenium script that would traverse this
awful website for me.</p>

<h2 id="selenium">Selenium</h2>

<p>Selenium is a terrific little service that allows you to
programatically navigate web pages. It is a great choice for
integration testing and end-to-end testing when you need more granular
control over your browser.</p>

<p>Selenium is available in most languages. I went with the <a href="http://selenium-python.readthedocs.org/">python
wrapper</a>.</p>

<p>As a warning, this is essentially a web-scraper. Scripts that
programatically navigate websites work best with plainly-named ID tags
and simple, native HTML widgets. The fewer bells and whistles, the
better. This makes a municipal website like www.cityofmadison.com a
great candidate for Selenium automation.</p>

<h2 id="building-busbot">Building “Busbot”</h2>

<p>Let’s walk through <code class="language-plaintext highlighter-rouge">busbot</code>. Here is the basic skeleton of a script.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Firefox</span><span class="p">()</span>
<span class="n">driver</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'http://google.com'</span><span class="p">)</span>
</code></pre></div></div>

<p>Running this script (after installing the <code class="language-plaintext highlighter-rouge">selenium</code> pip package) will
open Firefox to the Google homepage.</p>

<p>Instead of the Google homepage, let’s go to the first page of the
ordering process - <a href="https://www.cityofmadison.com/epayment/metro/busPass/index.cfm">this url</a>. Here we see our first obstacle - the
dreaded “Terms and Conditions”.</p>

<figure>
  <a href="/images/selenium/terms.png">
    <img alt="selenium terms" src="/images/selenium/terms.png" />
  </a>
  <figcaption>
    <p>To their credit, this is much better than the iTunes one</p>
  </figcaption>
</figure>

<p>This is easy enough with Selenium. We can select the element by ID,
click it, then do the same with the “confirm” button.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">selenium</span> <span class="kn">import</span> <span class="n">webdriver</span>

<span class="n">driver</span> <span class="o">=</span> <span class="n">webdriver</span><span class="p">.</span><span class="n">Firefox</span><span class="p">()</span>

<span class="n">driver</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'https://www.cityofmadison.com'</span>
           <span class="s">'/epayment/metro/busPass/index.cfm'</span><span class="p">)</span>

<span class="n">checkbox</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'acceptTerms'</span><span class="p">)</span>
<span class="n">checkbox</span><span class="p">.</span><span class="n">click</span><span class="p">()</span>
<span class="n">submit</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'submit'</span><span class="p">)</span>
<span class="n">submit</span><span class="p">.</span><span class="n">click</span><span class="p">()</span>
</code></pre></div></div>

<p>Works like a charm. The program passes the confirmation and follows a
redirection to the next page.</p>

<figure>
  <a href="/images/selenium/selenium1.png">
    <img alt="selenium selenium1" src="/images/selenium/selenium1.png" />
  </a>
</figure>

<p>Now we need to enter the quantity of tickets. We can grab the “Adult
10-Ride” quantity input by its unique ID and send text input.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">quantity_text</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'product_62'</span><span class="p">)</span>
<span class="n">quantity_text</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="s">'1'</span><span class="p">)</span>
</code></pre></div></div>

<p>Further down on the page, we find our first contact information form.</p>

<figure>
  <a href="/images/selenium/selenium2.png">
    <img alt="selenium selenium2" src="/images/selenium/selenium2.png" />
  </a>
</figure>

<p>These fields are missing ID’s. Do we slink away in defeat? Of course
not. Selenium’s API has ample methods for retrieving elements from the
DOM. As it happens, each input has a unique name attribute.</p>

<p>We simply need to retrieve each input by its <code class="language-plaintext highlighter-rouge">name</code> attribute and send
it text, just as we did before. But the iterative nature of this form
gives us a chance to be fancy. I chose to put each value in a
name/value <code class="language-plaintext highlighter-rouge">dict</code> and iterate over each pair.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Alex Recker'</span><span class="p">,</span>
          <span class="s">'Address'</span><span class="p">:</span> <span class="s">'123 Sesame St'</span><span class="p">,</span>
          <span class="s">'City'</span><span class="p">:</span> <span class="s">'Madison'</span><span class="p">,</span>
          <span class="s">'Zip'</span><span class="p">:</span> <span class="s">'53704'</span><span class="p">,</span>
          <span class="s">'email'</span><span class="p">:</span> <span class="s">'alex@reckerfamily.com'</span><span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">elem</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<p>What about “State”? This isn’t a text field on the page, so sending
input via the keyboard will not get it to select “WI”. We need to
treat the dropdown differently. We can select the element, then search
for child elements by tag name, which we expect to be option
elements. Selenium will return a list, allowing us to iteratively
inspect and click a qualifying <code class="language-plaintext highlighter-rouge">option</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="s">'Alex Recker'</span><span class="p">,</span>
          <span class="s">'Address'</span><span class="p">:</span> <span class="s">'123 Sesame St'</span><span class="p">,</span>
          <span class="s">'City'</span><span class="p">:</span> <span class="s">'Madison'</span><span class="p">,</span>
          <span class="s">'State'</span><span class="p">:</span> <span class="s">'WI'</span><span class="p">,</span>
          <span class="s">'Zip'</span><span class="p">:</span> <span class="s">'53704'</span><span class="p">,</span>
          <span class="s">'email'</span><span class="p">:</span> <span class="s">'alex@reckerfamily.com'</span><span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">elem</span> <span class="o">=</span> <span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">'State'</span><span class="p">:</span>  <span class="c1"># State Dropdown
</span>        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">elem</span><span class="p">.</span><span class="n">find_elements_by_tag_name</span><span class="p">(</span><span class="s">'option'</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">option</span><span class="p">.</span><span class="n">get_attribute</span><span class="p">(</span><span class="s">'value'</span><span class="p">)</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">option</span><span class="p">.</span><span class="n">click</span><span class="p">()</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">elem</span><span class="p">.</span><span class="n">send_keys</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></div>

<p>Next, we tick the “Shipping information same as Contact Information”
option and submit the form.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_name</span><span class="p">(</span><span class="s">'notice'</span><span class="p">).</span><span class="n">click</span><span class="p">()</span>  <span class="c1"># same as billing address...
</span><span class="n">driver</span><span class="p">.</span><span class="n">find_element_by_id</span><span class="p">(</span><span class="s">'submit'</span><span class="p">).</span><span class="n">click</span><span class="p">()</span>
</code></pre></div></div>

<p>The rest of the code is rinse and repeat. I’ve <a href="https://github.com/arecker/busbot">cleaned up the project</a>
and modified it to read personal data out of a YAML file before
execution - just in any fellow public transit warriors want to use it
themselves.</p>

<h2 id="look-mah---no-hands">Look, Mah - No Hands</h2>

<p>Here is a demo of the whole run through using fake data. The last page
throws a payment validation error. Call me a miser, but I didn’t feel
like giving away my <em>real</em> credit card number just for the sake of a
demo.</p>

<video controls="" width="700">
<source src="/vids/buspass.webm" type="video/webm" />
    Sorry, your browser doesn't support embedded videos.
</video>

<h2 id="taking-it-further">Taking it Further</h2>

<p>Looking <a href="http://selenium-python.readthedocs.org/">Selenium’s python API</a>, it’s not hard to imagine how to take
this further.</p>

<ol>
  <li>Validating payment information before submit with assert and
exceptions</li>
  <li>Custom configs to purchase with different options (card or check)</li>
  <li>Hooking into <code class="language-plaintext highlighter-rouge">crontab</code> for a truly automated experience</li>
</ol>

<p>Next time you find yourself wrestling with a website that should have
died decades ago, consider putting Selenium to work and getting on the
automation bus.</p>

    
    <hr/>
    <footer>
      <small>Last Updated: November 27 2020, 06:48:46 PM CST</small>
      <small>
	Powered by <a href="https://github.com/arecker/blog">jekyll</a> (<a class="code" href="https://github.com/arecker/blog/commit/776a3217ead01b9c9c8ac61d14ba1a9b42cfa404">776a321</a>)
      </small>
      <small>&copy; Copyright 2020 Alex Recker</small>
    </footer>
    
  </body>
</html>
